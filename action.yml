name: "Debug-It"
description: "Connect to the GitHub Actions runner via SSH/RDP/VNC."

inputs:
  tenant-id:
    description: "Azure Entra Tenant Id"
    required: true
  client-id:
    description: "Azure Entra Client Id"
    required: true
  authorized-user:
    description: "User authorized to access the runner"
    required: false
  ports:
    description: "Comma delimited list of ports to be forwarded"
    required: false
    default: "22"
  expiry:
    description: "Devtunnel expiry"
    required: false
    default: "1h"
runs:
  using: "composite"
  steps:
    - name: Add SSH keys
      shell: bash
      run: |
        SSH_KEYS_URL="https://github.com/${AUTHORIZED_USER:-$CURRENT_USER}.keys"
        echo "Setting public keys from $SSH_KEYS_URL"
        mkdir -p ~/.ssh
        touch ~/.ssh/authorized_keys
        curl $SSH_KEYS_URL >> ~/.ssh/authorized_keys
        chmod 700 ~/.ssh
        chmod 600 ~/.ssh/authorized_keys
      env:
        AUTHORIZED_USER: ${{ inputs.authorized-user }}
        CURRENT_USER: ${{ github.actor }}

    - name: Configure SSH permissions (windows)
      if: ${{ runner.os == 'Windows' }}
      shell: pwsh
      run: |
        cp "$HOME\.ssh\authorized_keys" "$env:ProgramData\ssh\administrators_authorized_keys"
        icacls "$env:ProgramData\ssh\administrators_authorized_keys" /inheritance:r /grant "Administrators:F" /grant "SYSTEM:F"

    - name: Install DevTunnel CLI (windows)
      id: install-win
      if: ${{ runner.os == 'Windows' }}
      shell: bash
      run: |
        mkdir -p $HOME/bin
        curl -sL -o $HOME/bin/devtunnel.exe https://aka.ms/TunnelsCliDownload/win-x64
        echo "pathname=$HOME/bin/devtunnel.exe" >> $GITHUB_OUTPUT

    - name: Install DevTunnel CLI (linux, macOS)
      id: install-other
      if: ${{ runner.os != 'Windows' }}
      shell: bash
      run: |
        curl -sL https://aka.ms/DevTunnelCliInstall | bash
        echo "pathname=$HOME/bin/devtunnel" >> $GITHUB_OUTPUT

    - name: Set context
      id: install
      shell: pwsh
      run: |
        if ($env:RUNNER_OS -eq "Windows") {
          echo "pathname=${{ steps.install-win.outputs.pathname }}" >> $env:GITHUB_OUTPUT
        } else {
          echo "pathname=${{ steps.install-other.outputs.pathname }}" >> $env:GITHUB_OUTPUT
        }

#    - name: Login to DevTunnels
#      shell: pwsh
#      run: |
#        $response = Invoke-RestMethod -Uri "$env:ACTIONS_ID_TOKEN_REQUEST_URL" -Headers @{ "Authorization" = "Bearer $env:ACTIONS_ID_TOKEN_REQUEST_TOKEN" }
#        $id_token = $response.value
#        & $env:DEVTUNNEL user login --entra --sp-tenant-id $env:TENANT_ID --sp-client-id $env:CLIENT_ID --federated-token "$id_token"
#      env:
#        DEVTUNNEL: ${{ steps.install.outputs.pathname }}
#        TENANT_ID: ${{ inputs.tenant-id }}
#        CLIENT_ID: ${{ inputs.client-id }}

    - name: Login to DevTunnels
      shell: bash
      run: |
        OIDC_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" | jq -r .value)
        if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" == "null" ]; then
          echo "::error::Failed to retrieve OIDC token."
          exit 1
        fi

        $DEVTUNNEL user login --entra --sp-tenant-id $TENANT_ID --sp-client-id $CLIENT_ID --federated-token "$OIDC_TOKEN"
      env:
        DEVTUNNEL: ${{ steps.install.outputs.pathname }}
        TENANT_ID: ${{ inputs.tenant-id }}
        CLIENT_ID: ${{ inputs.client-id }}
  
    - name: Start DevTunnel
      shell: bash
      run: |
        PORTS=$(echo "$PORTS" | sed 's/,/ -p /g; s/^/-p /')
        $DEVTUNNEL host $PORTS --expiration $EXPIRY --allow-anonymous
      env:
        DEVTUNNEL: ${{ steps.install.outputs.pathname }}
        PORTS: ${{ inputs.ports }}
        EXPIRY: ${{ inputs.expiry}}
