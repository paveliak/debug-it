name: "Debug-It"
description: "Connect to the GitHub Actions runner via SSH/RDP/VNC."

inputs:
  tenant-id:
    description: "Azure Entra Tenant Id"
    required: true
  client-id:
    description: "Azure Entra Client Id"
    required: true
  authorized-user:
    description: "User authorized to access the runner"
    required: false
  ports:
    description: "Comma delimited list of ports to be forwarded"
    required: false
    default: "22"
  expiry:
    description: "Devtunnel expiry"
    required: false
    default: "1h"
runs:
  using: "composite"
  steps:
    - name: Add SSH keys
      shell: bash
      run: |
        SSH_KEYS_URL="https://github.com/${AUTHORIZED_USER:-$CURRENT_USER}.keys"
        echo "Setting public keys from $SSH_KEYS_URL"
        mkdir -p ~/.ssh
        touch ~/.ssh/authorized_keys
        curl $SSH_KEYS_URL >> ~/.ssh/authorized_keys
        chmod 700 ~/.ssh
        chmod 600 ~/.ssh/authorized_keys
      env:
        AUTHORIZED_USER: ${{ inputs.authorized-user }}
        CURRENT_USER: ${{ github.actor }}

    - name: Configure SSH permissions (windows)
      if: ${{ runner.os == 'Windows' }}
      shell: bash
      run: |
        cp "$HOME/.ssh/authorized_keys" "$ProgramData/ssh/administrators_authorized_keys"
        icacls "$ProgramData/ssh/administrators_authorized_keys" "/inheritance:r" "/grant" "Administrators:F" "/grant" "SYSTEM:F"

    - name: Install DevTunnel CLI (windows)
      id: install-win
      if: ${{ runner.os == 'Windows' }}
      shell: bash
      run: |
        mkdir -p $HOME/bin
        curl -sL -o $HOME/bin/devtunnel.exe https://aka.ms/TunnelsCliDownload/win-x64
        echo "pathname=$HOME/bin/devtunnel.exe" >> $GITHUB_OUTPUT

    - name: Install DevTunnel CLI (linux, macOS)
      id: install-other
      if: ${{ runner.os != 'Windows' }}
      shell: bash
      run: |
        curl -sL https://aka.ms/DevTunnelCliInstall | bash
        echo "pathname=$HOME/bin/devtunnel" >> $GITHUB_OUTPUT

    - name: Set context
      id: install
      shell: bash
      run: |
        if [ "$RUNNER_OS" = "Windows" ]; then
          echo "pathname=${{ steps.install-win.outputs.pathname }}" >> $GITHUB_OUTPUT
        else
          echo "pathname=${{ steps.install-other.outputs.pathname }}" >> $GITHUB_OUTPUT
        fi

    - name: Login to DevTunnels
      shell: bash
      run: |
        ID_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" | jq -r .value)
        $DEVTUNNEL user login --entra --sp-tenant-id $TENANT_ID --sp-client-id $CLIENT_ID --federated-token "$ID_TOKEN"
      env:
        DEVTUNNEL: ${{ steps.install.outputs.pathname }}
        TENANT_ID: ${{ inputs.tenant-id }}
        CLIENT_ID: ${{ inputs.client-id }}
  
    - name: Start DevTunnel
      shell: bash
      run: |
        PORTS=$(echo "$PORTS" | sed 's/,/ -p /g; s/^/-p /')
        $DEVTUNNEL host $PORTS --expiration $EXPIRY --allow-anonymous
      env:
        DEVTUNNEL: ${{ steps.install.outputs.pathname }}
        PORTS: ${{ inputs.ports }}
        EXPIRY: ${{ inputs.expiry}}
